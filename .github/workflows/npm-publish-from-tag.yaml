name: Reusable NPM Publish from Tag

on:
  workflow_call:
    inputs:
      node_version:
        description: 'Node.js version to use'
        type: string
        required: false
        default: '24'
      skip-tests-until-date:
        required: false
        type: string
        description: 'Saltar tests hasta esta fecha (formato: YYYY-MM-DD)'        

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.success.outputs.ok }}    
    steps:
      - uses: actions/checkout@v4
      - name: Get package.json version
        id: get_package_version
        run: echo "version=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"
      - name: Check versions from tag and package.json
        if: github.ref != format('refs/tags/v{0}', steps.get_package_version.outputs.version)
        run: |
          echo "Error: Versions does not match. Tag: (${{ github.ref }}),  package.json: (v${{ steps.get_package_version.outputs.version }})"
          exit 1
      - name: Set the result
        if: github.ref == format('refs/tags/v{0}', steps.get_package_version.outputs.version)
        id: success
        run: |
          echo "Good: Versions match. (${{ github.ref }})"
          echo "ok=ok" >> "$GITHUB_OUTPUT"
  
  publish:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.status == 'ok'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '${{ inputs.node_version }}'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci

      - name: Check if tests should be skipped
        id: check_skip
        run: |
          if [ -n "${{ inputs.skip-tests-until-date }}" ]; then
            # Para macOS/BSD y Linux
            CURRENT_EPOCH=$(date +%s)
            SKIP_UNTIL_EPOCH=$(date -d "${{ inputs.skip-tests-until-date }}" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "${{ inputs.skip-tests-until-date }}" +%s 2>/dev/null || echo "")
            
            if [ -n "$SKIP_UNTIL_EPOCH" ] && [ $CURRENT_EPOCH -lt $SKIP_UNTIL_EPOCH ]; then
              echo "skip_tests=true" >> $GITHUB_OUTPUT
              echo "⚠️ Tests saltados hasta ${{ inputs.skip-tests-until-date }} (fecha actual: $(date +%Y-%m-%d))"
            else
              echo "skip_tests=false" >> $GITHUB_OUTPUT
              echo "✅ Tests se ejecutarán (fecha límite: ${{ inputs.skip-tests-until-date }})"
            fi
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
            echo "✅ Tests se ejecutarán (no hay fecha de salto)"
          fi      

      - name: Run tests
        if: steps.check_skip.outputs.skip_tests != 'true'
        run: npm test

      - name: Publish to NPM
        run: |
          VERSION=$(node -p "require('./package.json').version")
          case $VERSION in
            *beta*)
              TAG="--tag beta"
              ;;
            *alpha*)
              TAG="--tag alpha"
              ;;
            *rc*)
              TAG="--tag rc"
              ;;
            *)
              TAG=""
              ;;
          esac
          echo "Publishing version $VERSION with tag: $TAG"
          npm publish --provenance $TAG
